<?xml version="1.0" encoding="UTF-8"?>
<!-- Configuration for Apache Ant. -->
<project name="agora" default="all" basedir=".">

<!-- Project configuration -->

	<property name="doc-dir" value="doc"/>

	<!-- PHP -->
	<property name="php-doc-dir" value="${doc-dir}/php"/>
	<property name="php-doxyfile" value="dev/Doxyfile" />
	<property name="php-coverage-dir" value="${doc-dir}/coverage"/>
	<property name="php-tests-location" value="tests"/>

	<!-- JS -->
	<property name="js-src" value="web/js"/>
	<property name="js-doc-dir" value="${doc-dir}/js"/>

<!-- Global rules -->

	<!-- Build all automatically generated files. -->
	<target name="all" depends="clean,fix,test,doc">
		<!-- Dependencies do anything we need here. -->
	</target>
	
	<!-- Delete all automatically generated files. -->
	<target name="clean">
		<echo message="Clearing old autogenerated content…"/>
		<!-- Remove old code coverage report. -->
		<delete dir="${php-coverage-dir}"/>
		<!-- Remove old PHP documentation. -->
		<delete dir="${php-doc-dir}"/>
		<!-- Remove old JS documentation. -->
		<delete dir="${js-doc-dir}"/>
	</target>

<!-- Automatic fixes -->

	<!-- Run all automatic fixes. -->
	<target name="fix" depends="fix-classes,fix-rights">
		<!-- Dependencies do anything we need here. -->
	</target>

	<!-- Build PHP classes list. -->
	<target name="fix-classes">
		<exec executable="dev/list-classes.sh">
		</exec>
	</target>

	<!-- Reset rights on files. -->
	<target name="fix-rights">
		<exec executable="dev/set-rights.sh">
		</exec>
	</target>

<!-- Test rules -->

	<!-- Run all tests. -->
	<target name="test" depends="test-php">
		<!-- Dependencies do anything we need here. -->
	</target>

	<!-- Make PHP unit tests. -->
	<target name="test-php">
		<echo message="Running PHP unit tests…"/>
		<!-- Run tests. -->
		<exec executable="phpunit" failonerror="true" >
			<arg value="--coverage-html" /> <arg value="${php-coverage-dir}" />
			<arg value="--test-suffix" /> <arg value="Test.php" />
			<arg value="--process-isolation" />
			<arg value="${php-tests-location}" />
		</exec>
	</target>
	
<!-- Documentation rules -->

	<!-- Build all documentation. -->
	<target name="doc" depends="doc-php,doc-js">
		<!-- Dependencies do anything we need here. -->
	</target>
	
	<!-- Build PHP documentation. -->
	<target name="doc-php">
		<echo message="Building PHP documentation…"/>
		<exec executable="doxygen">
			<arg value="${php-doxyfile}" />
		</exec>
	</target>
	
	<!-- Build JS documentation -->
	<target name="doc-js">
		<echo message="Building JS documentation…"/>
		<exec executable="yuidoc">
			<arg value="${js-src}" />
			<arg value="--no-color" />
			<arg value="-o" /> <arg value="${js-doc-dir}" />
		</exec>
	</target>
	
</project>
